<html>
<head>
<title>Hello</title>
<style>

.fill {
    width: 100%;
    height: 100%;
}

table {
    border-collapse: collapse;
}
th, td {
    padding: 0;
}

.question {
}

.category {
    font-size: small;
    color: blue;
}

</style>
</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="https://raw.github.com/dglittle/myutil/master/u.js"></script>
<script>

function onError() {
    var div = $('<div style="padding:20px;width:300px;height:200px"/>')
    div.append($('<span/>').text("Oops. Not sure what happened. I recommend refreshing the page."))
    div.append($('<br/>'))
    div.append($('<br/>'))
    div.append($('<span/>').text("If you were typing something, and you want to save your work, click "))
    div.append($('<a href="#"/>').text("here").click(function (e) {
        e.preventDefault()
        _.closeDialog()
    }))
    div.append($('<span/>').text(" and copy-paste your work somewhere else, and then refresh the page."))
    _.dialog(div)
}

function rpc(func, arg, cb, eb) {
    $.ajax({
        url : '/rpc',
        type : 'post',
        data : _.json({ func : func, arg : arg }),
        success : cb,
        error : function (o) {
            if (eb) return eb(o)
            onError()
        }
    })
}

function drawTask(task) {
    var div = $('<div/>')
    div.append($('<div class="question"/>').text(task.question).append($('<span style="margin-left:10px" class="category"/>').text(task.category)))
    var input = $('<textarea style="width:500px;height:150px"/>')
    div.append(input)
    div.append($('<br/>'))
    var characters = $('<span/>')
    div.append(characters)
    div.append($('<span/>').text(' characters. Must be between 150 and 450 characters'))
    function updateCharacters() {
        characters.text(input.val().length)
    }
    updateCharacters()
    input.keydown(updateCharacters).keyup(updateCharacters).change(updateCharacters)

    div.append($('<br/>'))
    div.append($('<br/>'))

    var urlBox = $('<input type="text" style="width:100%"/>')
    div.append(_.splitHorz(0.01, null,
        $('<div/>').html('see&nbsp;url:&nbsp;'),
        urlBox).css('width', '500px').css('height', '1em'))

    div.append($('<br/>'))

    div.append($('<button/>').text('submit').click(function () {
        var s = input.val()
        var url = urlBox.val()
        if (s.length < 150) {
            alert('answer is not long enough: must be at least 150 characters')
            return
        }
        if (s.length > 450) {
            alert('answer is too long: cannot be more than 450 characters')
            return
        }
        if (url.length > 0) {
            // if (url.length < 2 && s.match(/http/)) {
            //     alert('please move url to the "see url:" box')
            //     return
            // }
            // if (url.length < 2) {
            //     alert('must input a reference url')
            //     return
            // }
            if (!url.match(/^https?:\/\//)) {
                alert('url must begin with http:// or https://')
                return
            }
            if (!url.match(/^https?:\/\/.{2,1024}$/)) {
                alert('url is either too short or too long')
                return
            }
        } else {
            url = null
        }
        rpc('submitTask', { 'task' : task._id, 'answer' : s, 'url' : url }, function (success) {
            setStatus(success ? 'successfully submitted task' : 'alas, I failed to submit the task')
            updateUser()
            goGetAvailableTasks()
        }, function () {
            setStatus('alas, I failed to submit the task')
        })
    }))
    div.append($('<button style="margin-left:10px"/>').text('cancel').click(function () {
        rpc('ungrabTask', null, function () {
            goGetAvailableTasks()
        })
    }))
    div.append($('<span style="margin-left:10px"/>').text('grabbed for next '))
    var timespan = $('<span/>')
    div.append(timespan)
    div.append($('<span/>').text(' minutes'))
    div.append($('<button style="margin-left:10px"/>').text('try to grab for more time').click(function () {
        goGrabTask(task._id)
    }))
    function updateTimespan() {
        timespan.text(Math.round((task.availableToAnswerAt - _.time()) / (1000 * 60)))
    }
    updateTimespan()
    var timespanInterval = setInterval(function () {
        if (timespan.is(":visible"))
            updateTimespan()
        else
            clearInterval(timespanInterval)
    }, 1000)
    return div
}

function goGrabTask(_id) {
    rpc('grabTask', _id, function (task) {
        if (task) {
            g_output.empty().append(drawTask(task))
        } else {
            setStatus('sorry, that task was taken')
            goGetAvailableTasks()
        }
    })
}

function drawGrabbaleTask(task) {
    var div = $('<div/>')
    div.append($('<button/>').text('try to grab').click(function () {
        goGrabTask(task._id)
    })).append($('<span style="margin-left:10px" class="question"/>').text(task.question)).append($('<span style="margin-left:10px" class="category"/>').text(task.category))
    return div
}

function goGetAvailableTasks() {
    rpc('getAvailableTasks', null, function (tasks) {
        g_output.empty()
        g_output.append($('<div style="font-weight:bold;margin-bottom:10px"/>').text('answer writing tasks, $0.28 each'))
        var div = $('<div/>')
        _.each(tasks, function (task) {
            div.append(drawGrabbaleTask(task))
        })
        g_output.append(div)
        g_output.append($('<button/>').text('more...').click(function () {
            goGetAvailableTasks()
        }))
    })
}

function drawFeedTask(task) {
    var div = $('<div style="width:700px"/>')
    div.append($('<div style="font-size:small;color:lightgrey"/>').text('' + new Date(task.touchedAt)))
    div.append($('<span class="question"/>').text(task.question))
    div.append($('<span style="margin-left:10px" class="category"/>').text(task.category))
    div.append($('<br/>'))
    if (task.grabbedBy)
        div.append($('<span style="color:green"/>').text('grabbed by ' + task.grabbedBy))
    if (task.answer)
        div.append($('<div/>').append($('<span style="font-weight:bold;font-size:small"/>').text('answer: ')).append($('<span style="color:grey"/>').text(task.answer)))
    if (task.url)
        div.append($('<div/>').append($('<span style="font-weight:bold;font-size:small"/>').text('see url: ')).append($('<span style="color:grey"/>').text(task.url)))
    if (task.answeredBy)
        div.append($('<span style="color:green"/>').text('answered by ' + task.answeredBy))
    return div
}

function goGetFeed() {
    rpc('getFeed', null, function (tasks) {
        var div = $('<div/>')
        _.each(tasks, function (task) {
            div.append(drawFeedTask(task).css('margin-bottom', '20px'))
        })
        g_output.empty().append(div)
    })
}

function setStatus(msg) {
    g_status.empty().append($('<div/>').text(msg))
}

function redrawUser(user) {
    var s = 'welcome ' + user.name
    s += ' (' + (user.answerCount || 0) + ' answers)'
    g_user.text(s)
}

function updateUser() {
    rpc('getUser', null, redrawUser)
}

$(function () {
    rpc('getUser', null, function (user) {
        if (!user) {
            document.location.href = '/login'
            return
        }

        g_status = $('<div/>')
        g_user = $('<div style="margin-right:10px"/>')
        g_output = $('<div class="fill"/>')
        var buttons = $('<div/>')
        buttons.append($('<button/>').html('available&nbsp;tasks').click(function () {
            goGetAvailableTasks()
        }))
        buttons.append($('<button/>').html('activity&nbsp;feed').click(function () {
            goGetFeed()
        }))

        var top = $('<div/>')
        top.append(g_status.css('float', 'left'))
        top.append(buttons.css('float', 'right'))
        top.append(g_user.css('float', 'right'))
        top.append($('<div style="clear:both"/>'))

        $('body').append(_.splitVert(32, null, top, g_output))

        redrawUser(user)
        if (user.grabbedTask) {
            goGrabTask(user.grabbedTask)
        } else {
            goGetAvailableTasks()
        }
    })
})

</script>

</body>
</html>
